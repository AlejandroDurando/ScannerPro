<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pro Direct</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <style>
        /* Eliminamos cualquier control nativo del navegador */
        video::-webkit-media-controls { display: none !important; }
        video::-webkit-media-controls-start-playlist-button { display: none !important; }
        video::-webkit-media-controls-enclosure { display: none !important; }
        
        video {
            width: 100%;
            height: 100vh;
            object-fit: cover;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
            background: black;
        }

        .ui-layer {
            position: fixed;
            z-index: 10;
            bottom: 40px;
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }

        #snap {
            pointer-events: auto;
            width: 80px;
            height: 80px;
            background: white;
            border: 6px solid rgba(59, 130, 246, 0.5);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #preview {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: black;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
    </style>
</head>
<body class="bg-black">

    <video id="video" autoplay muted playsinline webkit-playsinline></video>

    <div class="ui-layer">
        <button id="snap"></button>
    </div>

    <div id="preview">
        <canvas id="canvasOut" class="max-w-full h-auto rounded-lg shadow-2xl mt-10"></canvas>
        <div class="flex gap-4 mt-auto mb-10 w-full max-w-sm">
            <button onclick="location.reload()" class="flex-1 bg-zinc-800 text-white p-5 rounded-2xl font-bold">REPETIR</button>
            <button id="save" class="flex-1 bg-blue-600 text-white p-5 rounded-2xl font-bold">DESCARGAR PDF</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const snapBtn = document.getElementById('snap');
        const preview = document.getElementById('preview');
        const canvasOut = document.getElementById('canvasOut');

        // Función para arrancar la cámara
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });
                
                video.srcObject = stream;

                // Intentar reproducir automáticamente
                video.play().catch(err => {
                    console.log("Esperando interacción para reproducir");
                    // Si falla el auto-play, forzamos con un click en cualquier parte
                    document.body.addEventListener('click', () => video.play(), { once: true });
                });

            } catch (err) {
                alert("Error de cámara: " + err.message);
            }
        }

        // Capturar y procesar con OpenCV
        snapBtn.onclick = () => {
            if (typeof cv === 'undefined') return alert("Cargando motor de imagen...");

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            let src = cv.imread(canvas);
            let dst = new cv.Mat();
            
            // Filtro de "Escaner" profesional
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
            cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 15, 12);
            
            cv.imshow('canvasOut', dst);
            preview.style.display = 'flex';
            
            src.delete(); dst.delete();
        };

        // Guardar PDF
        document.getElementById('save').onclick = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const imgData = canvasOut.toDataURL('image/jpeg', 0.8);
            doc.addImage(imgData, 'JPEG', 0, 0, 210, 297);
            doc.save("documento_escaneado.pdf");
        };

        window.onload = startCamera;
    </script>
</body>
</html>