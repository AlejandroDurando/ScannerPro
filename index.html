<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pro Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <style>
        video, canvas { width: 100%; height: auto; border-radius: 1rem; background: #000; }
        #log { font-family: monospace; font-size: 10px; color: #ffeb3b; }
    </style>
</head>
<body class="bg-black text-white p-4 overflow-hidden">

    <div class="max-w-md mx-auto flex flex-col h-[90vh]">
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold">SCANNER<span class="text-blue-500">PRO</span></h1>
            <div id="statusDot" class="w-3 h-3 bg-red-500 rounded-full"></div>
        </header>

        <div id="log" class="mb-2 h-10 overflow-y-auto">Iniciando sistema...</div>

        <div class="relative flex-grow flex items-center justify-center bg-gray-900 rounded-2xl overflow-hidden border-2 border-gray-800">
            <video id="video" autoplay muted playsinline></video>
        </div>

        <div id="controls" class="mt-6 flex justify-center items-center gap-6">
            <button id="snap" class="w-20 h-20 bg-white rounded-full border-4 border-blue-500 flex items-center justify-center active:scale-90 transition-transform">
                <div class="w-14 h-14 bg-blue-600 rounded-full"></div>
            </button>
        </div>

        <div id="preview" class="hidden fixed inset-0 bg-black z-50 p-4 flex flex-col items-center">
            <canvas id="canvasOut"></canvas>
            <div class="flex gap-4 mt-6 w-full">
                <button onclick="location.reload()" class="flex-1 bg-gray-700 p-4 rounded-xl font-bold">REINTENTAR</button>
                <button id="save" class="flex-1 bg-blue-600 p-4 rounded-xl font-bold">GUARDAR PDF</button>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const log = document.getElementById('log');
        const statusDot = document.getElementById('statusDot');

        function printLog(msg) {
            log.innerHTML += "> " + msg + "<br>";
            console.log(msg);
        }

        // 1. Cargar OpenCV
        var Module = {
            onRuntimeInitialized() {
                printLog("OpenCV cargado correctamente.");
                statusDot.classList.replace('bg-red-500', 'bg-green-500');
            }
        };

        // 2. Arrancar Cámara con fuerza
        async function initCamera() {
            printLog("Solicitando cámara...");
            const constraints = {
                video: { 
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                printLog("Cámara trasera conectada.");
                
                // Forzar reproducción en móviles
                video.onloadedmetadata = () => {
                    video.play().catch(e => printLog("Error play: " + e.message));
                };
            } catch (err) {
                printLog("Error: " + err.name + " - " + err.message);
                // Si falla, intentamos cualquier cámara
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(s => { 
                        video.srcObject = s;
                        printLog("Usando cámara por defecto.");
                    })
                    .catch(e => printLog("Fallo total: " + e.message));
            }
        }

        // 3. Captura y Procesado
        document.getElementById('snap').onclick = () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            try {
                let src = cv.imread(canvas);
                let dst = new cv.Mat();
                cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
                cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 15, 12);
                cv.imshow('canvasOut', dst);
                document.getElementById('preview').classList.remove('hidden');
                src.delete(); dst.delete();
            } catch (e) {
                printLog("Error procesado: " + e.message);
            }
        };

        // 4. Guardar PDF
        document.getElementById('save').onclick = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const imgData = document.getElementById('canvasOut').toDataURL('image/jpeg', 0.8);
            doc.addImage(imgData, 'JPEG', 0, 0, 210, 297);
            doc.save("scanner.pdf");
        };

        window.onload = initCamera;
    </script>
</body>
</html>